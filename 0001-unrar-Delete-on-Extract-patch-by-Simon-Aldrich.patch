From 1831dedae75e4d554496f1986b03dde206e1dee4 Mon Sep 17 00:00:00 2001
From: DroidFreak32 <rushabshah32@gmail.com>
Date: Tue, 7 May 2019 18:44:00 +0530
Subject: [PATCH] unrar: Delete on Extract patch by Simon Aldrich

    * Reference: https://simon.aldrich.cc/blog/2014/06/unrar-delete-on-extract/
---
 cmddata.cpp | 2 ++
 cmdmix.cpp  | 4 ++--
 extract.cpp | 6 ++++++
 loclang.hpp | 2 ++
 options.hpp | 1 +
 volume.cpp  | 6 ++++++
 6 files changed, 19 insertions(+), 2 deletions(-)

diff --git a/cmddata.cpp b/cmddata.cpp
index 82d24f4..351b20a 100644
--- a/cmddata.cpp
+++ b/cmddata.cpp
@@ -355,6 +355,8 @@ void CommandData::ProcessSwitch(const wchar *Switch)
           case 'H':
             OpenShared=true;
             break;
+          case 'E':
+            DeleteArchives=true;
           case 'F':
             DeleteFiles=true;
             break;
diff --git a/cmdmix.cpp b/cmdmix.cpp
index 1fc4b8c..89092fb 100644
--- a/cmdmix.cpp
+++ b/cmdmix.cpp
@@ -61,8 +61,8 @@ void CommandData::OutHelp(RAR_EXIT ExitCode)
     MUNRARTitle1,MRARTitle2,MCHelpCmd,MCHelpCmdE,MCHelpCmdL,
     MCHelpCmdP,MCHelpCmdT,MCHelpCmdV,MCHelpCmdX,MCHelpSw,MCHelpSwm,
     MCHelpSwAT,MCHelpSwAC,MCHelpSwAD,MCHelpSwAG,MCHelpSwAI,MCHelpSwAP,
-    MCHelpSwCm,MCHelpSwCFGm,MCHelpSwCL,MCHelpSwCU,MCHelpSwDH,MCHelpSwEP,
-    MCHelpSwEP3,MCHelpSwEP4,MCHelpSwF,MCHelpSwIDP,MCHelpSwIERR,
+    MCHelpSwCm,MCHelpSwCFGm,MCHelpSwCL,MCHelpSwCU,MCHelpSwDE,MCHelpSwDH,
+    MCHelpSwEP,MCHelpSwEP3,MCHelpSwEP4,MCHelpSwF,MCHelpSwIDP,MCHelpSwIERR,
     MCHelpSwINUL,MCHelpSwIOFF,MCHelpSwKB,MCHelpSwME,MCHelpSwN,MCHelpSwNa,
     MCHelpSwNal,MCHelpSwO,MCHelpSwOC,MCHelpSwOL,MCHelpSwOP,MCHelpSwOR,
     MCHelpSwOW,MCHelpSwP,MCHelpSwR,MCHelpSwRI,MCHelpSwSC,MCHelpSwSI,
diff --git a/extract.cpp b/extract.cpp
index dc109b9..f817cb0 100644
--- a/extract.cpp
+++ b/extract.cpp
@@ -240,6 +240,12 @@ EXTRACT_ARC_CODE CmdExtract::ExtractArchive()
         break;
   }
 
+  if ((*Cmd->Command=='E' || *Cmd->Command=='X') &&
+      (Cmd->DeleteArchives == true))
+  {
+    mprintf(MUnlinking, Arc.FileName);
+    Arc.Delete();
+  }
 
 #if !defined(SFX_MODULE) && !defined(RARDLL)
   if (Cmd->Test && Arc.Volume)
diff --git a/loclang.hpp b/loclang.hpp
index ad7d0c9..6998637 100644
--- a/loclang.hpp
+++ b/loclang.hpp
@@ -65,6 +65,7 @@
 #define   MCHelpSwCFGm       L"\n  cfg-          Disable read configuration"
 #define   MCHelpSwCL         L"\n  cl            Convert names to lower case"
 #define   MCHelpSwCU         L"\n  cu            Convert names to upper case"
+#define   MCHelpSwDE         L"\n  de            Delete archive(s) after extracting"
 #define   MCHelpSwDF         L"\n  df            Delete files after archiving"
 #define   MCHelpSwDH         L"\n  dh            Open shared files"
 #define   MCHelpSwDR         L"\n  dr            Delete files to Recycle Bin"
@@ -210,6 +211,7 @@
 #define   MCRCFailed         L"\n%-20s - checksum error"
 #define   MExtrTest          L"\n\nTesting archive %s\n"
 #define   MExtracting        L"\n\nExtracting from %s\n"
+#define   MUnlinking         L"\n\nDeleting %s\n"
 #define   MUseCurPsw         L"\n%s - use current password ?"
 #define   MCreatDir          L"\nCreating    %-56s"
 #define   MExtrSkipFile      L"\nSkipping    %-56s"
diff --git a/options.hpp b/options.hpp
index 1131958..4c5dfc9 100644
--- a/options.hpp
+++ b/options.hpp
@@ -163,6 +163,7 @@ class RAROptions
     bool KeepBroken;
     bool OpenShared;
     bool DeleteFiles;
+    bool DeleteArchives;
 
 #ifdef _WIN_ALL
     bool AllowIncompatNames; // Allow names with trailing dots and spaces.
diff --git a/volume.cpp b/volume.cpp
index 917851d..a97d3ef 100644
--- a/volume.cpp
+++ b/volume.cpp
@@ -34,6 +34,12 @@ bool MergeArchive(Archive &Arc,ComprDataIO *DataIO,bool ShowFileName,wchar Comma
 
 
   Arc.Close();
+  if ((Command=='X' || Command=='E') &&
+      (Cmd->DeleteArchives == true))
+  {
+    mprintf(MUnlinking, Arc.FileName);
+    Arc.Delete();
+  }
 
   wchar NextName[NM];
   wcsncpyz(NextName,Arc.FileName,ASIZE(NextName));
-- 
2.37.1

