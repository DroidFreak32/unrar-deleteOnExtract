From 14f4748ce15458e9970e5c956debc89353d13a1b Mon Sep 17 00:00:00 2001
From: DroidFreak32 <rushabshah32@gmail.com>
Date: Tue, 7 May 2019 18:44:00 +0530
Subject: [PATCH 1/2] unrar: Delete on Extract patch by Simon Aldrich

    * Reference: https://simon.aldrich.cc/blog/2014/06/unrar-delete-on-extract/
---
 cmddata.cpp |  2 ++
 cmdmix.cpp  |  4 ++--
 extinfo.cpp | 16 ++++++++--------
 extract.cpp |  6 ++++++
 loclang.hpp |  2 ++
 options.hpp |  1 +
 readme.txt  | 17 +++++++++++++++++
 volume.cpp  |  6 ++++++
 8 files changed, 44 insertions(+), 10 deletions(-)

diff --git a/cmddata.cpp b/cmddata.cpp
index 82d24f4..351b20a 100644
--- a/cmddata.cpp
+++ b/cmddata.cpp
@@ -355,6 +355,8 @@ void CommandData::ProcessSwitch(const wchar *Switch)
           case 'H':
             OpenShared=true;
             break;
+          case 'E':
+            DeleteArchives=true;
           case 'F':
             DeleteFiles=true;
             break;
diff --git a/cmdmix.cpp b/cmdmix.cpp
index 1fc4b8c..89092fb 100644
--- a/cmdmix.cpp
+++ b/cmdmix.cpp
@@ -61,8 +61,8 @@ void CommandData::OutHelp(RAR_EXIT ExitCode)
     MUNRARTitle1,MRARTitle2,MCHelpCmd,MCHelpCmdE,MCHelpCmdL,
     MCHelpCmdP,MCHelpCmdT,MCHelpCmdV,MCHelpCmdX,MCHelpSw,MCHelpSwm,
     MCHelpSwAT,MCHelpSwAC,MCHelpSwAD,MCHelpSwAG,MCHelpSwAI,MCHelpSwAP,
-    MCHelpSwCm,MCHelpSwCFGm,MCHelpSwCL,MCHelpSwCU,MCHelpSwDH,MCHelpSwEP,
-    MCHelpSwEP3,MCHelpSwEP4,MCHelpSwF,MCHelpSwIDP,MCHelpSwIERR,
+    MCHelpSwCm,MCHelpSwCFGm,MCHelpSwCL,MCHelpSwCU,MCHelpSwDE,MCHelpSwDH,
+    MCHelpSwEP,MCHelpSwEP3,MCHelpSwEP4,MCHelpSwF,MCHelpSwIDP,MCHelpSwIERR,
     MCHelpSwINUL,MCHelpSwIOFF,MCHelpSwKB,MCHelpSwME,MCHelpSwN,MCHelpSwNa,
     MCHelpSwNal,MCHelpSwO,MCHelpSwOC,MCHelpSwOL,MCHelpSwOP,MCHelpSwOR,
     MCHelpSwOW,MCHelpSwP,MCHelpSwR,MCHelpSwRI,MCHelpSwSC,MCHelpSwSI,
diff --git a/extinfo.cpp b/extinfo.cpp
index 5cb90a4..59678d8 100644
--- a/extinfo.cpp
+++ b/extinfo.cpp
@@ -9,7 +9,7 @@
 #endif
 
 #ifdef _UNIX
-#include "uowners.cpp"
+//#include "uowners.cpp"
 #ifdef SAVE_LINKS
 #include "ulinks.cpp"
 #endif
@@ -27,8 +27,8 @@ void SetExtraInfo20(CommandData *Cmd,Archive &Arc,wchar *Name)
   {
 #ifdef _UNIX
     case UO_HEAD:
-      if (Cmd->ProcessOwners)
-        ExtractUnixOwner20(Arc,Name);
+//      if (Cmd->ProcessOwners)
+//        ExtractUnixOwner20(Arc,Name);
       break;
 #endif
 #ifdef _WIN_ALL
@@ -49,9 +49,9 @@ void SetExtraInfo20(CommandData *Cmd,Archive &Arc,wchar *Name)
 void SetExtraInfo(CommandData *Cmd,Archive &Arc,wchar *Name)
 {
 #ifdef _UNIX
-  if (!Cmd->Test && Cmd->ProcessOwners && Arc.Format==RARFMT15 &&
-      Arc.SubHead.CmpName(SUBHEAD_TYPE_UOWNER))
-    ExtractUnixOwner30(Arc,Name);
+//  if (!Cmd->Test && Cmd->ProcessOwners && Arc.Format==RARFMT15 &&
+//      Arc.SubHead.CmpName(SUBHEAD_TYPE_UOWNER))
+//    ExtractUnixOwner30(Arc,Name);
 #endif
 #ifdef _WIN_ALL
   if (!Cmd->Test && Cmd->ProcessOwners && Arc.SubHead.CmpName(SUBHEAD_TYPE_ACL))
@@ -66,8 +66,8 @@ void SetExtraInfo(CommandData *Cmd,Archive &Arc,wchar *Name)
 void SetFileHeaderExtra(CommandData *Cmd,Archive &Arc,wchar *Name)
 {
 #ifdef _UNIX
-   if (Cmd->ProcessOwners && Arc.Format==RARFMT50 && Arc.FileHead.UnixOwnerSet)
-     SetUnixOwner(Arc,Name);
+//   if (Cmd->ProcessOwners && Arc.Format==RARFMT50 && Arc.FileHead.UnixOwnerSet)
+//     SetUnixOwner(Arc,Name);
 #endif
 }
 
diff --git a/extract.cpp b/extract.cpp
index dc109b9..f817cb0 100644
--- a/extract.cpp
+++ b/extract.cpp
@@ -240,6 +240,12 @@ EXTRACT_ARC_CODE CmdExtract::ExtractArchive()
         break;
   }
 
+  if ((*Cmd->Command=='E' || *Cmd->Command=='X') &&
+      (Cmd->DeleteArchives == true))
+  {
+    mprintf(MUnlinking, Arc.FileName);
+    Arc.Delete();
+  }
 
 #if !defined(SFX_MODULE) && !defined(RARDLL)
   if (Cmd->Test && Arc.Volume)
diff --git a/loclang.hpp b/loclang.hpp
index ad7d0c9..6998637 100644
--- a/loclang.hpp
+++ b/loclang.hpp
@@ -65,6 +65,7 @@
 #define   MCHelpSwCFGm       L"\n  cfg-          Disable read configuration"
 #define   MCHelpSwCL         L"\n  cl            Convert names to lower case"
 #define   MCHelpSwCU         L"\n  cu            Convert names to upper case"
+#define   MCHelpSwDE         L"\n  de            Delete archive(s) after extracting"
 #define   MCHelpSwDF         L"\n  df            Delete files after archiving"
 #define   MCHelpSwDH         L"\n  dh            Open shared files"
 #define   MCHelpSwDR         L"\n  dr            Delete files to Recycle Bin"
@@ -210,6 +211,7 @@
 #define   MCRCFailed         L"\n%-20s - checksum error"
 #define   MExtrTest          L"\n\nTesting archive %s\n"
 #define   MExtracting        L"\n\nExtracting from %s\n"
+#define   MUnlinking         L"\n\nDeleting %s\n"
 #define   MUseCurPsw         L"\n%s - use current password ?"
 #define   MCreatDir          L"\nCreating    %-56s"
 #define   MExtrSkipFile      L"\nSkipping    %-56s"
diff --git a/options.hpp b/options.hpp
index 1131958..4c5dfc9 100644
--- a/options.hpp
+++ b/options.hpp
@@ -163,6 +163,7 @@ class RAROptions
     bool KeepBroken;
     bool OpenShared;
     bool DeleteFiles;
+    bool DeleteArchives;
 
 #ifdef _WIN_ALL
     bool AllowIncompatNames; // Allow names with trailing dots and spaces.
diff --git a/readme.txt b/readme.txt
index a1f820a..1067087 100644
--- a/readme.txt
+++ b/readme.txt
@@ -1,3 +1,20 @@
+Notes from Phillip Pearson (http://myelin.nz/) --
+
+- This is forked from https://github.com/pmachapman/unrar and verified
+  to be identical to the 5.8.4 source archive linked from
+  https://www.rarlab.com/rar_add.htm (aside from the .gitignore that
+  I've added).
+
+- I've modified the makefile and code to produce a static unrar
+  binary, which should hopefully be suitable for upload to services
+  like Google Cloud Functions and Google App Engine that provide a
+  general execution environment but don't allow you to run 'apt-get
+  install unrar'.
+
+Enjoy!
+
+--- readme.txt from upstream archive follows ---
+
 
                        Portable UnRAR version
 
diff --git a/volume.cpp b/volume.cpp
index 917851d..a97d3ef 100644
--- a/volume.cpp
+++ b/volume.cpp
@@ -34,6 +34,12 @@ bool MergeArchive(Archive &Arc,ComprDataIO *DataIO,bool ShowFileName,wchar Comma
 
 
   Arc.Close();
+  if ((Command=='X' || Command=='E') &&
+      (Cmd->DeleteArchives == true))
+  {
+    mprintf(MUnlinking, Arc.FileName);
+    Arc.Delete();
+  }
 
   wchar NextName[NM];
   wcsncpyz(NextName,Arc.FileName,ASIZE(NextName));
-- 
2.44.0

